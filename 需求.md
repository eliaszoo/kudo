# 奖励系统需求规格说明书

## 1. 背景与目标
- 背景：通过微信机器人记录孩子完成任务得到的奖励，以及奖励的使用情况，并可随时查询可用余额。
- 总体目标：提供一套可扩展的、基于 Go + MySQL 的记账与查询系统，支持多用户与多种奖励类型，并通过大模型（MCP 协议）解析自然语言消息为具体指令。

## 2. 范围与非目标
- 范围：
  - 微信机器人/公众号消息接入（文本为主，语音/图片经转文字后处理）。
  - 基于 RESTful API 的后端服务，记录奖励授予、消费、查询等行为。
  - 多用户家庭维度管理：一个家庭内可有监护人（家长）与受益人（孩子）。
  - 自定义奖励类型：零花钱、时间（分钟）、积分等，可扩展。
  - 大模型意图解析：将自然语言消息映射为结构化指令并执行。
- 非目标：
  - 实现复杂的支付系统、真实资金结算或提现；仅做记账与查询。
  - 完整的微信公众号平台开发文档重述；本项目以必要的接入约束为准。

## 3. 术语与角色
- 家庭（Family）：一个组织单位，包含监护人与孩子。
- 监护人（Guardian）：创建与管理家庭、定义奖励类型、授予奖励、查询与调整记录。
- 孩子（Child）：奖励的受益人，可查看自己的余额与使用记录。
- 奖励类型（RewardType）：具体的奖励维度，如 money（零花钱，以分为单位）、time（分钟）、points（积分）、custom（自定义整数单位）。
- 账户（Account）：孩子在某一奖励类型上的余额账户。
- 交易（Transaction）：对账户余额的原子变更，分为 credit（入账）与 debit（出账）。

## 4. 交互渠道与消息规范
- 渠道：
  - 微信公众号/机器人：通过消息回调（Webhook）接收用户文本；语音/图片需先转文字。
  - 本地开发调试：提供模拟消息接口，便于无微信环境时联调。
- 文本消息规范（示例）：
  - 授予奖励（money）：
    - “女儿完成作业，奖励100元”
    - “给小明零花钱+50元，备注：考试满分”
  - 消费奖励（money）：
    - “女儿用100元购买玩具”
    - “小明-20元，备注：买文具”
  - 查询余额：
    - “女儿还剩多少零花钱？”
    - “查询小明积分余额”
  - 自定义奖励类型：
    - “新增奖励类型：看电视，单位：分钟”
    - “为小明新增类型：积分，初始0”
- 结构化指令（建议，用于可靠解析）：
  - 以 `#cmd` 开头，后接 JSON：
    - `#cmd {"action":"grant","child":"小明","type":"money","value":10000,"note":"完成作业"}`
    - `#cmd {"action":"spend","child":"小明","type":"money","value":2000,"note":"买文具"}`
    - `#cmd {"action":"query","child":"小明","type":"money"}`
    - `#cmd {"action":"define_type","type":"time","name":"看电视","unit":"minute"}`
  - money 的 `value` 单位为分（100元=10000）。time 的 `value` 单位为分钟。points 的 `value` 为整数点数。custom 的单位由类型定义决定。

## 5. 大模型（MCP）集成
- MCP 工具列表（对 LLM 暴露的操作）：
  - `create_reward_type`: 定义奖励类型
    - 入参：`{family_id, name, unit_kind: "money|time|points|custom", unit_label?, init_value?}`
    - 出参：`{reward_type_id}`
  - `grant_reward`: 授予奖励（credit）
    - 入参：`{family_id, child_name|child_id, reward_type_id|unit_kind, value, note?, idempotency_key?}`
    - 出参：`{transaction_id, new_balance}`
  - `spend_reward`: 消费奖励（debit）
    - 入参：同上，`value` 为消费值，若余额不足需返回错误。
    - 出参：`{transaction_id, new_balance}`
  - `query_balance`: 查询余额
    - 入参：`{family_id, child_id|child_name, reward_type_id|unit_kind}`
    - 出参：`{balance}`
  - `list_transactions`: 查询交易记录
    - 入参：`{family_id, child_id, reward_type_id?, limit?, before_id?}`
    - 出参：`[{id, type, value, note, created_at}]`
  - `adjust_transaction`: 调整一笔交易的数值与备注（需要监护人权限）
    - 入参：`{transaction_id, new_value?, new_note?}`
    - 出参：`{transaction_id}`
- 意图识别：LLM 从自然语言中抽取 `action/child/type/value/note` 等，并调用上述工具；失败时返回结构化错误。
- 可靠性：所有变更类操作支持 `idempotency_key`，避免重复调用造成多次入账/出账。

## 6. 后端接口（REST v1）
- 版本与前缀：`/api/v1`
- 认证与授权：
  - 微信渠道：根据微信开放平台校验签名；将消息中的 `openid` 映射到系统用户。
  - 开发调试：使用 `Authorization: Bearer <token>` 简化鉴权。
- 资源与端点：
  - 奖励类型
    - `POST /reward_types`
      - 请求：`{family_id, name, unit_kind, unit_label?}`
      - 响应：`{id, name, unit_kind, unit_label}`
  - 授予奖励（入账）
    - `POST /rewards/grant`
      - 请求：`{family_id, child_id, reward_type_id, value, note?, idempotency_key?}`
      - 响应：`{transaction_id, balance}`
  - 消费奖励（出账）
    - `POST /rewards/spend`
      - 同上，余额不足返回 `409 insufficient_balance`
  - 查询余额
    - `GET /balances?family_id=...&child_id=...&reward_type_id=...`
      - 响应：`{balance}`
  - 交易列表
    - `GET /transactions?family_id=...&child_id=...&reward_type_id=...&limit=...&before_id=...`
      - 响应：`[{id,type, value, note, created_at}]`
  - 交易调整
    - `POST /transactions/{id}/adjust`
      - 请求：`{new_value?, new_note?}`（仅监护人）
      - 响应：`{id}`
- 响应格式：
  - 成功：`{code:0, data:...}`
  - 失败：`{code:int, message:string, details?:object}`，HTTP 状态与业务码一致性：400/401/403/404/409/422/500。
- 示例（cURL）：
  - `curl -X POST /api/v1/rewards/grant -H 'Content-Type: application/json' -d '{"family_id":1,"child_id":2,"reward_type_id":10,"value":10000,"note":"完成作业"}'`

## 7. 数据模型（MySQL）
- 设计原则：
  - 每个孩子在每种奖励类型上拥有一个账户（Account），余额为整数。
  - 交易为不可分割的入账/出账记录，变更余额通过事务与行级锁保证一致。
  - 金额统一使用分（`value` 为整数）。时间单位统一为分钟。积分为整数。自定义单位以类型的 `unit_label` 说明。
- 表结构（DDL 示意）：
  - `families`
    - `id BIGINT PK AUTO_INCREMENT`
    - `name VARCHAR(64)`
    - 索引：`PRIMARY(id)`
  - `users`
    - `id BIGINT PK AUTO_INCREMENT`
    - `family_id BIGINT NOT NULL`
    - `role ENUM('guardian','child') NOT NULL`
    - `display_name VARCHAR(64) NOT NULL`
    - `wechat_openid VARCHAR(128)`
    - `is_active TINYINT(1) DEFAULT 1`
    - 索引：`idx_family(role, family_id)`, `idx_openid(wechat_openid)`
  - `reward_types`
    - `id BIGINT PK AUTO_INCREMENT`
    - `family_id BIGINT NOT NULL`
    - `name VARCHAR(64) NOT NULL`
    - `unit_kind ENUM('money','time','points','custom') NOT NULL`
    - `unit_label VARCHAR(32)`
    - 唯一：`uniq_family_name(family_id, name)`
  - `accounts`
    - `id BIGINT PK AUTO_INCREMENT`
    - `family_id BIGINT NOT NULL`
    - `child_id BIGINT NOT NULL`
    - `reward_type_id BIGINT NOT NULL`
    - `balance INT NOT NULL DEFAULT 0`
    - 唯一：`uniq_acc(child_id, reward_type_id)`
  - `transactions`
    - `id BIGINT PK AUTO_INCREMENT`
    - `account_id BIGINT NOT NULL`
    - `type ENUM('credit','debit') NOT NULL`
    - `value INT NOT NULL`  -- 分/分钟/积分/自定义整数
    - `note VARCHAR(255)`
    - `created_by BIGINT NOT NULL`  -- 操作人（通常为监护人）
    - `idempotency_key VARCHAR(64)`
    - `created_at DATETIME NOT NULL`
    - 索引：`idx_account_created(account_id, created_at)`, `idx_idem(idempotency_key)`
  - `audit_logs`
    - `id BIGINT PK AUTO_INCREMENT`
    - `family_id BIGINT`
    - `user_id BIGINT`
    - `action VARCHAR(32)`
    - `payload JSON`
    - `created_at DATETIME`
- 约束与事务：
  - 授予/消费时使用 `SELECT ... FOR UPDATE` 锁定 `accounts` 行，串行化余额更新。
  - 余额不能为负数；若消费导致负数，返回 `409 insufficient_balance`。
  - 写操作要求提供 `idempotency_key`，若重复则返回已执行结果。

## 8. 安全与隐私
- 不记录明文敏感信息（如第三方令牌）；凭据使用安全存储与加密散列。
- 避免在日志中输出个人隐私与密钥；审计日志仅记录必要字段。
- 授权策略：仅监护人可定义奖励类型、授予/调整交易；孩子可查询自己的余额与记录。

## 9. 错误码
- `0`：成功
- `400 invalid_request`：参数错误
- `401 unauthorized`：未认证
- `403 forbidden`：无权限
- `404 not_found`：资源不存在
- `409 insufficient_balance`：余额不足
- `422 invalid_intent`：意图解析失败
- `500 internal_error`：服务器内部错误

## 10. 业务流程
- 授予奖励：监护人 -> 机器人/接口 -> LLM 解析为 `grant_reward` -> 账户入账 -> 返回新余额。
- 消费奖励：监护人/孩子 -> 机器人/接口 -> 解析为 `spend_reward` -> 余额扣减（不足则失败）。
- 查询余额：消息解析为 `query_balance` -> 返回当前余额。
- 定义类型：监护人 -> `create_reward_type` -> 创建账户（延迟或按需）。

## 11. 测试用例（验收）
- 用例1：授予100元 -> 余额+10000 分。
- 用例2：消费50元 -> 余额-5000 分。
- 用例3：余额不足消费 -> 返回 409。
- 用例4：新增类型“看电视/分钟”，授予30分钟 -> 查询显示30。
- 用例5：重复消息（相同 `idempotency_key`） -> 仅记一次。
- 用例6：按时间倒序分页查询交易 -> 返回指定 `limit` 条。

## 12. 部署与配置
- 环境变量：
  - `DB_DSN`：MySQL 连接串
  - `WECHAT_TOKEN`：微信校验 Token（如启用）
  - `API_TOKEN`：开发调试 Bearer Token
  - `MCP_SERVER_URL`：LLM 工具调用端点
- 迁移：提供建表 SQL 与索引；初始化默认奖励类型（money）。

## 13. 非功能性要求
- 可用性：主要为家庭级低并发场景，保证事务一致性与幂等。
- 监控与日志：关键操作写入审计表；错误集中上报。
- 可扩展性：奖励类型与单位可扩展；接口版本化（`/api/v1`）。